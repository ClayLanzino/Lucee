<?xml version="1.0" encoding="UTF-8"?>
<project default="run" basedir="." name="Lucee">

<macrodef name="echots">
    <attribute name="message"/>
    <sequential>
      <local name="timestamp" />
      <tstamp>
        <format property="timestamp" pattern="yyyy-MM-dd HH:mm:ss" />
      </tstamp>
      <echo message="---------- ${timestamp} - @{message} ----------" />
    </sequential>
  </macrodef>

<target name="run">
	<echots message="within run of upload s3"/>

<script language="CFML">
<![CDATA[
try{
	NL="
";
	SystemOutput("inside upload-to-s3.xml",1,1);

	src.jar=server.system.properties.luceejar;
	src.core=server.system.properties.luceeCore;
	src.dir=getDirectoryFromPath(src.jar);
	src.jarName=listLast(src.jar,"\/");
	src.coreName=listLast(src.core,"\/");
	src.version=mid(src.coreName,1,len(src.coreName)-4);
	


	// no S3 credentials?
	if(isNull(server.system.environment.S3_ACCESS_ID) 
		|| isNull(server.system.environment.S3_SECRET_KEY)) {
		
		SystemOutput("no S3 credentials defined to upload to S3",1,1);
		return;
	}
	else {
		trg.dir="s3://#server.system.environment.S3_ACCESS_ID_DOWNLOAD#:#server.system.environment.S3_SECRET_KEY_DOWNLOAD#@/lucee-downloads/";
	}
	trg.jar=trg.dir&src.jarName;
	trg.core=trg.dir&src.coreName;

	// copy jar
	SystemOutput("upload #src.jarName# to S3",1,1);
	if(fileExists(trg.jar)) fileDelete(trg.jar);
	fileCopy(src.jar,trg.jar);

	// copy core
	SystemOutput("upload #src.coreName# to S3",1,1);
	if(fileExists(trg.core)) fileDelete(trg.core);
	fileCopy(src.core,trg.core);

	// create war
	src.warName="lucee-"&src.version&".war";
	src.war=src.dir&src.warName;
	trg.war=trg.dir&src.warName;
	SystemOutput("upload #src.warName# to S3",1,1);
	
	/*zip action="zip" file=src.war overwrite=true {

		// loader
		zipparam source=src.jar entrypath="WEB-INF/lib/lucee.jar";
       
		// common files
		// zipparam source=commonDir;
					
		// website files
		// zipparam source=webDir;
					
		// war files
		// zipparam source=warDir;

	}
	fileCopy(src.war,trg.war);*/

		

}
catch(e){
	SystemOutput(serialize(e),1,1);
	rethrow;
}
]]>
  </script>

</target>
</project>